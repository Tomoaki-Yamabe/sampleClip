# 要件定義書

## はじめに

本システムは、自動運転シーン検索のためのマルチモーダル検索システムです。nuScenesデータセットを使用し、カメラ画像、車両センサーの時系列データ（MCAP形式）、シーン説明テキストを統合して検索可能にします。現在のKaggleミームデータセットベースのシステムから、自動運転データに特化したシステムへと進化させ、AWSサーバーレスアーキテクチャで低コスト運用可能なMVPとして実装します。

## 用語集

- **nuScenes**: 自動運転研究用の公開データセット。カメラ画像、LiDAR、レーダー、GPS/IMU、アノテーションを含む
- **MCAP**: 時系列データを効率的に保存するためのコンテナフォーマット。ROSメッセージやセンサーデータの記録に使用される
- **埋め込みシステム**: テキスト、画像、時系列データを統一された埋め込みベクトル空間に変換するシステム
- **ベクトルデータベース**: 高次元ベクトルの類似度検索を効率的に行うデータベース
- **バックエンドAPI**: FastAPIベースのRESTful APIサーバー
- **フロントエンドアプリケーション**: Next.jsベースのユーザーインターフェース
- **CDKスタック**: AWS Cloud Development Kitを使用したインフラストラクチャ定義
- **サーバーレスアーキテクチャ**: サーバー管理不要のクラウドアーキテクチャ（Lambda、API Gateway、S3等）
- **時系列エンコーダー**: MCAP形式の時系列データをベクトル表現に変換するエンコーダー
- **シーン**: nuScenesにおける20秒間の運転データ。複数のカメラ画像、センサーデータ、アノテーションを含む

## 要件

### 要件 1

**ユーザーストーリー:** 自動運転エンジニアとして、事前準備されたシーンデータをシステムで利用したい。これにより、画像とセンサーデータを統合して検索できる。

#### 受入基準

1. WHEN システムが起動する THEN バックエンドAPIはS3 Vectorsから埋め込みベクトルデータベースにアクセスする
2. WHEN ベクトルデータベースがロードされる THEN システムは各シーンの画像埋め込み、テキスト埋め込み、メタデータを取得できる
3. WHEN データベースが初期化される THEN システムは最低10シーン分のデータを含む
4. WHEN 各シーンデータが読み込まれる THEN システムはシーンID、画像URL、シーン説明、位置情報を保持する
5. WHERE ベクトルデータベースにアクセスできない THEN システムは起動エラーを返す

### 要件 2

**ユーザーストーリー:** 自動運転エンジニアとして、テキストクエリを使ってシーンを検索したい。これにより、自然言語の説明を使って関連する運転シナリオを見つけられる。

#### 受入基準

1. WHEN ユーザーがテキストクエリを送信する THEN バックエンドAPIはテキストを埋め込みベクトルにエンコードする
2. WHEN テキスト埋め込みが生成される THEN バックエンドAPIはS3 Vectors QueryVectors APIを使用してベクトル類似度検索を実行する
3. WHEN 検索結果が見つかる THEN バックエンドAPIは類似度スコアが0.3以上の上位5件の最も類似したシーンを返す
4. WHEN 検索結果が返される THEN バックエンドAPIは各シーンの画像URL、シーン説明、類似度スコアを含める
5. WHERE 類似度閾値を超える結果がない THEN バックエンドAPIは空の結果セットを返す

### 要件 3

**ユーザーストーリー:** 自動運転エンジニアとして、画像を使ってシーンを検索したい。これにより、視覚的に類似する運転シナリオを見つけられる。

#### 受入基準

1. WHEN ユーザーが検索用に画像をアップロードする THEN バックエンドAPIは画像をクエリ埋め込みベクトルにエンコードする
2. WHEN クエリ埋め込みが生成される THEN バックエンドAPIはS3 Vectors QueryVectors APIを使用してベクトル類似度検索を実行する
3. WHEN 類似画像が見つかる THEN バックエンドAPIは類似度スコアでランク付けされた上位5件の結果を返す
4. WHEN 結果が返される THEN バックエンドAPIは各シーンの画像URL、シーン説明、類似度スコアを含める
5. WHERE アップロードされた画像が5MBを超える THEN バックエンドAPIはファイルサイズ制限エラーを返す

### 要件 4

**ユーザーストーリー:** システム管理者として、低コストでサーバーレスアーキテクチャを使ってシステム全体をAWSにデプロイしたい。これにより、月額コストを最小化しながらポートフォリオとして公開できる。

#### 受入基準

1. WHEN CDKスタックがデプロイされる THEN システムはLambda関数、API Gateway、S3バケットを含む必要最小限のAWSリソースをプロビジョニングする
2. WHEN バックエンドAPIがリクエストを受信する THEN システムはAWS Lambda関数で処理を実行する
3. WHEN 静的ファイルが保存される THEN システムはS3 Standardストレージクラスを使用する
4. WHEN Lambda関数が実行される THEN システムはメモリを512MB以下に制限してコストを最適化する
5. WHEN API Gatewayが設定される THEN システムはHTTP APIを使用してREST APIよりもコストを削減する

### 要件 5

**ユーザーストーリー:** システム管理者として、フロントエンドアプリケーションを低コストで静的サイトとしてデプロイしたい。これにより、CloudFront CDNを通じて効率的かつ安価に配信できる。

#### 受入基準

1. WHEN CDKスタックがデプロイされる THEN システムはNext.jsフロントエンドアプリケーションを静的アセットとしてビルドする
2. WHEN 静的アセットが生成される THEN CDKスタックは静的ウェブサイトホスティング用に設定されたS3バケットにそれらをアップロードする
3. WHEN S3バケットが設定される THEN CDKスタックはS3バケットを指すCloudFrontディストリビューションを作成する
4. WHEN ユーザーがフロントエンドアプリケーションにアクセスする THEN システムはCloudFrontを通じてコンテンツを配信する
5. WHEN CloudFrontが設定される THEN システムはキャッシュTTLを24時間に設定してオリジンリクエストを最小化する

### 要件 6

**ユーザーストーリー:** 自動運転エンジニアとして、埋め込み空間を2次元で可視化したい。これにより、シーン間の関係性を直感的に理解できる。

#### 受入基準

1. WHEN フロントエンドアプリケーションが可視化ページを表示する THEN システムは事前計算されたUMAP座標データをロードする
2. WHEN UMAP座標データがロードされる THEN システムはインタラクティブな散布図として各シーンをプロットする
3. WHEN ユーザーがシーンポイントにマウスオーバーする THEN システムはシーンID、説明、サムネイル画像をツールチップで表示する
4. WHEN ユーザーがシーンポイントをクリックする THEN システムは詳細情報パネルを表示する
5. WHEN ユーザーが散布図上の領域を選択する THEN システムは選択範囲内のシーンリストを表示する

### 要件 7

**ユーザーストーリー:** システム管理者として、シンプルな監視とログ記録が欲しい。これにより、問題をトラブルシューティングできる。

#### 受入基準

1. WHEN Lambda関数が実行される THEN システムは基本的な操作ログをCloudWatch Logsに記録する
2. WHEN APIリクエストが受信される THEN システムはリクエストパス、ステータスコード、レスポンス時間を記録する
3. WHEN エラーが発生する THEN システムはエラーメッセージをCloudWatchに記録する
4. WHEN CloudWatchログが保存される THEN システムはログ保持期間を7日間に設定してストレージコストを削減する
5. WHERE Lambda関数がタイムアウトする THEN システムはタイムアウトエラーを明示的にログに記録する
