# 実装計画

- [x] 1. データ準備とベクトルDB構築





  - nuScenes Miniデータセットから10シーン分のデータを抽出し、埋め込みベクトルとUMAP座標を生成する
  - 既存のエンコーダーを使用して画像とテキストの埋め込みを生成
  - UMAPで2次元座標を計算
  - JSON形式でベクトルDBを作成
  - _要件: 1.1, 1.2, 1.3, 1.4, 6.1_

- [x] 1.1 nuScenesデータ抽出スクリプトの作成



  - nuScenes Miniデータセットから10シーンを選択
  - 各シーンのカメラ画像を抽出（前方カメラ優先）
  - シーン説明と位置情報をメタデータとして抽出
  - 画像を512x512にリサイズして保存
  - _要件: 1.1_



- [x] 1.2 埋め込みベクトル生成
  - 既存のテキストエンコーダーで各シーン説明を埋め込みベクトルに変換
  - 既存の画像エンコーダーで各画像を埋め込みベクトルに変換
  - ベクトルがL2正規化されていることを確認
  - _要件: 1.2_

- [ ]* 1.3 埋め込み正規化のプロパティテストを作成
  - **Property 2: テキスト埋め込みの正規化**
  - **検証: 要件 2.1**

- [ ]* 1.4 埋め込み正規化のプロパティテストを作成
  - **Property 3: 画像埋め込みの正規化**


  - **検証: 要件 3.1**

- [x] 1.5 UMAP座標の生成
  - 画像埋め込みベクトルをUMAPで2次元に削減
  - 座標が有限値であることを確認
  - _要件: 6.1_

- [x]* 1.6 UMAP座標のプロパティテストを作成


  - **Property 7: UMAP座標の存在性**
  - **Property 8: UMAP座標の有限性**
  - **検証: 要件 6.1, 6.2**

- [x] 1.7 ベクトルDBのJSON生成
  - すべてのデータを統合してJSON形式で保存
  - 必須フィールド（scene_id, description, location, image_path, embeddings, umap_coords）を含める
  - _要件: 1.2, 1.4_

- [ ]* 1.8 ベクトルDB完全性のプロパティテストを作成
  - **Property 1: ベクトルデータベースの完全性**
  - **検証: 要件 1.2, 1.4**

- [x] 2. バックエンドAPI実装（Lambda）





  - FastAPIベースの検索APIを実装
  - テキスト検索とイメージ検索のエンドポイントを作成
  - エンコーダーとベクトルDBのロード機能を実装
  - _要件: 2.1, 2.2, 3.1, 3.2_

- [x] 2.1 Lambda関数の基本構造を作成


  - FastAPIアプリケーションのセットアップ
  - Lambda用のハンドラー関数を実装
  - 環境変数の設定（S3バケット名、モデルパス）
  - _要件: 4.2_

- [x] 2.2 エンコーダーモジュールの実装


  - TextEncoderクラスの実装（ONNXモデルロード、推論）
  - ImageEncoderクラスの実装（ONNXモデルロード、推論）
  - S3からモデルファイルをロードする機能
  - _要件: 2.1, 3.1_

- [x] 2.3 ベクトルデータベースモジュールの実装


  - VectorDatabaseクラスの実装
  - S3からJSONファイルをロードする機能
  - コサイン類似度検索の実装
  - 類似度閾値フィルタリング（0.3以上）
  - _要件: 1.1, 2.2, 3.2_

- [ ]* 2.4 検索結果ランキングのプロパティテストを作成
  - **Property 4: 検索結果のランキングと件数制限**
  - **検証: 要件 2.3, 3.3**

- [ ]* 2.5 類似度閾値のプロパティテストを作成
  - **Property 6: 類似度閾値フィルタリング**
  - **検証: 要件 2.3**

- [x] 2.6 テキスト検索エンドポイントの実装


  - POST /search/text エンドポイント
  - リクエストバリデーション（テキスト長制限）
  - テキストエンコーディングと検索実行
  - レスポンス形式の整形
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ]* 2.7 検索結果構造のプロパティテストを作成
  - **Property 5: 検索結果の構造完全性**
  - **検証: 要件 2.4, 3.4**

- [x] 2.8 画像検索エンドポイントの実装


  - POST /search/image エンドポイント
  - 画像アップロードの処理（multipart/form-data）
  - ファイルサイズバリデーション（5MB制限）
  - 画像エンコーディングと検索実行
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ]* 2.9 画像検索のユニットテストを作成
  - ファイルサイズ超過のエラーハンドリングテスト
  - サポートされていない画像形式のテスト
  - 正常な画像検索のテスト
  - _要件: 3.5_

- [x] 2.10 エラーハンドリングの実装


  - カスタム例外クラスの定義
  - グローバルエラーハンドラーの実装
  - エラーレスポンスの標準化
  - _要件: 2.5, 3.5_

- [x] 2.11 ロギング機能の実装


  - CloudWatch Logsへの構造化ログ出力
  - リクエスト/レスポンスのメタデータ記録
  - エラートレースの記録
  - _要件: 7.1, 7.2, 7.3_

- [ ]* 2.12 Lambda関数の統合テストを作成
  - テキスト検索のエンドツーエンドテスト
  - 画像検索のエンドツーエンドテスト
  - エラーケースのテスト

- [ ] 3. チェックポイント - バックエンドテスト確認
  - すべてのテストが通ることを確認し、問題があれば質問する

- [ ] 4. フロントエンド実装（Next.js）
  - 既存のミーム検索UIをベースに自動運転シーン検索UIを実装
  - テキスト検索と画像検索のインターフェース
  - 検索結果の表示グリッド
  - _要件: 2.4, 3.4_

- [ ] 4.1 プロジェクト構造のセットアップ
  - Next.js 15プロジェクトの初期化（既存を更新）
  - Tailwind CSS 4の設定
  - TypeScript型定義の作成
  - 環境変数の設定（API_URL）
  - _要件: 5.1_

- [ ] 4.2 API通信レイヤーの実装
  - 検索APIクライアントの実装
  - TypeScript型定義（SearchRequest, SearchResponse, SceneResult）
  - エラーハンドリング
  - _要件: 2.4, 3.4_

- [ ] 4.3 検索インターフェースコンポーネントの実装
  - SearchInterfaceコンポーネント（モード切り替え）
  - TextSearchFormコンポーネント
  - ImageUploadFormコンポーネント（ドラッグ&ドロップ対応）
  - _要件: 2.1, 3.1_

- [ ] 4.4 検索結果表示コンポーネントの実装
  - ResultsGridコンポーネント（レスポンシブグリッド）
  - SceneCardコンポーネント（画像、説明、類似度スコア）
  - 空状態の表示
  - _要件: 2.4, 3.4_

- [ ] 4.5 メインページの実装
  - app/page.tsxの実装
  - 検索状態管理（React hooks）
  - ローディング状態の表示
  - エラー表示
  - _要件: 2.4, 3.4_

- [ ]* 4.6 フロントエンドのユニットテストを作成
  - コンポーネントのレンダリングテスト
  - ユーザーインタラクションのテスト
  - API通信のモックテスト

- [ ] 5. UMAP可視化機能の実装
  - インタラクティブな散布図コンポーネント
  - マウスオーバーとクリックのインタラクション
  - 領域選択機能
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 5.1 可視化ライブラリのセットアップ
  - Plotly.jsまたはD3.jsのインストール
  - TypeScript型定義の追加
  - _要件: 6.1_

- [ ] 5.2 UMAP座標データのロード機能
  - S3からUMAP座標JSONをフェッチ
  - データのキャッシング
  - _要件: 6.1_

- [ ] 5.3 散布図コンポーネントの実装
  - ScatterPlotコンポーネント
  - 各シーンをプロット
  - ズーム・パン機能
  - _要件: 6.2_

- [ ] 5.4 インタラクション機能の実装
  - マウスオーバーでツールチップ表示
  - クリックで詳細パネル表示
  - 領域選択でシーンリスト表示
  - _要件: 6.3, 6.4, 6.5_

- [ ] 5.5 可視化ページの作成
  - app/visualization/page.tsxの実装
  - ナビゲーションリンクの追加
  - _要件: 6.2_

- [ ]* 5.6 可視化機能のユニットテストを作成
  - 散布図のレンダリングテスト
  - インタラクションのテスト
  - データロードのテスト

- [ ] 6. チェックポイント - フロントエンドテスト確認
  - すべてのテストが通ることを確認し、問題があれば質問する

- [ ] 7. AWSインフラストラクチャ（CDK）の実装
  - CDKスタックの作成
  - Lambda、API Gateway、S3、CloudFrontのプロビジョニング
  - デプロイスクリプトの作成
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 7.1 CDKプロジェクトのセットアップ
  - CDKプロジェクトの初期化
  - 必要な依存関係のインストール
  - cdk.jsonの設定
  - _要件: 4.1_

- [ ] 7.2 S3バケットの定義
  - データバケット（モデル、ベクトルDB、画像）
  - フロントエンドバケット（静的ホスティング）
  - バケットポリシーとCORS設定
  - _要件: 4.3_

- [ ] 7.3 Lambda関数の定義
  - Lambda関数リソースの定義
  - メモリ512MB、タイムアウト30秒の設定
  - 環境変数の設定
  - S3読み取り権限の付与
  - _要件: 4.2, 4.4_

- [ ] 7.4 API Gatewayの定義
  - HTTP APIの作成
  - CORS設定
  - Lambda統合の設定
  - ルート定義（/search/text, /search/image）
  - _要件: 4.2, 4.5_

- [ ] 7.5 CloudFrontディストリビューションの定義
  - S3オリジンの設定
  - キャッシュポリシー（24時間TTL）
  - API Gatewayへのプロキシ設定
  - HTTPS強制
  - _要件: 5.3, 5.4, 5.5_

- [ ] 7.6 CloudWatch Logsの設定
  - Lambda関数のログ保持期間（7日間）
  - ログストリームの設定
  - _要件: 7.4_

- [ ] 7.7 CDK出力の定義
  - API Gateway URL
  - CloudFront Distribution URL
  - S3バケット名
  - _要件: 4.1_

- [ ]* 7.8 CDKスタックのユニットテストを作成
  - リソースの存在確認
  - プロパティの検証
  - IAMポリシーの検証

- [ ] 8. デプロイとデータアップロード
  - モデルとデータをS3にアップロード
  - CDKスタックのデプロイ
  - フロントエンドのビルドとデプロイ
  - _要件: 4.1, 5.2_

- [ ] 8.1 モデルのONNX変換
  - 既存のPyTorchモデルをONNX形式に変換
  - モデルサイズの最適化
  - 推論速度の検証
  - _要件: 4.4_

- [ ] 8.2 データのS3アップロード
  - ONNXモデルをS3にアップロード
  - ベクトルDBをS3にアップロード
  - シーン画像をS3にアップロード
  - _要件: 4.3_

- [ ] 8.3 Lambda関数のパッケージング
  - 依存関係のインストール（requirements.txt）
  - Lambda Layerの作成（ONNXランタイム）
  - デプロイパッケージの作成
  - _要件: 4.2_

- [ ] 8.4 CDKスタックのデプロイ
  - cdk bootstrapの実行（初回のみ）
  - cdk deployの実行
  - デプロイ結果の確認
  - _要件: 4.1_

- [ ] 8.5 フロントエンドのビルドとデプロイ
  - Next.jsの静的エクスポート（next build && next export）
  - 環境変数の注入
  - S3へのアップロード
  - CloudFrontキャッシュの無効化
  - _要件: 5.1, 5.2_

- [ ]* 8.6 デプロイ後の統合テストを実行
  - API Gatewayエンドポイントのテスト
  - CloudFront経由のフロントエンドアクセステスト
  - エンドツーエンドの検索フローテスト

- [ ] 9. 最終チェックポイント - 全体動作確認
  - すべてのテストが通ることを確認し、問題があれば質問する

- [ ] 10. ドキュメント作成
  - README.mdの更新
  - デプロイ手順の記載
  - アーキテクチャ図の追加
  - _要件: すべて_

- [ ] 10.1 README.mdの更新
  - プロジェクト概要の記載
  - 技術スタックの説明
  - アーキテクチャ図の追加
  - _要件: すべて_

- [ ] 10.2 デプロイ手順の記載
  - 前提条件（AWS CLI、CDK、Node.js、Python）
  - データ準備手順
  - デプロイコマンド
  - トラブルシューティング
  - _要件: 4.1, 5.1_

- [ ] 10.3 コスト見積もりの記載
  - 月額コストの内訳
  - 無料枠の説明
  - コスト最適化のヒント
  - _要件: 4.3, 4.4, 4.5_

- [ ] 10.4 今後の拡張案の記載
  - より多くのシーンの追加
  - MCAP時系列データの統合
  - マルチモーダル融合検索
  - _要件: すべて_

## Phase 2.5: S3 Vectors移行（Change Request）

このフェーズでは、既存のS3 JSONベースのベクトルストレージからS3 Vectors (GA)へ移行します。これにより、パフォーマンスの向上、スケーラビリティの改善、メンテナンスコストの削減を実現します。

### 移行の背景
- **パフォーマンス**: メモリ内検索からマネージドベクトル検索へ（サブセカンド〜100msのクエリ時間）
- **スケーラビリティ**: 数千シーンから数百万シーンへのスケール対応
- **コスト**: Lambda メモリ使用量の削減（512MB → 256MB）
- **メンテナンス**: ベクトル検索ロジックのAWSマネージド化

- [x] 11. S3 Vectors環境構築

  - S3 Vector Bucketとインデックスの作成
  - CDKスタックの更新
  - _要件: 1.1, 2.2, 3.2_

- [x] 11.1 S3 Vectors バケットとインデックスの作成


  - Vector Bucketの作成（`mcap-search-vectors`）
  - テキスト埋め込み用インデックスの作成（256次元、コサイン類似度）
  - 画像埋め込み用インデックスの作成（256次元、コサイン類似度）
  - **注意**: 現在の環境ではSCPによりS3 Vectorsの作成が制限されています
  - スクリプトは作成済み（`data_preparation/create_s3_vectors.py`）

  - 本番環境または権限のある環境で実行可能: `uvx --with boto3 python create_s3_vectors.py`


  - _要件: 1.1_

- [ ] 11.2 CDKスタックのS3 Vectors対応
  - VectorBucketリソースの追加
  - Lambda関数へのS3 Vectors権限付与
  - 環境変数の更新（VECTOR_BUCKET_NAME, INDEX_NAME）
  - _要件: 4.1_

- [ ] 12. データ移行スクリプトの作成
  - 既存JSONデータをS3 Vectorsに移行
  - メタデータファイルの生成

  - _要件: 1.2, 1.4_


- [ ] 12.1 S3 Vectors移行スクリプトの実装
  - 既存のvector_db.jsonを読み込み
  - PutVectors APIを使用してベクトルをアップロード
  - メタデータファイル（scenes_metadata.json）を生成
  - バッチ処理とエラーハンドリング


  - _要件: 1.2, 1.4_

- [ ] 12.2 移行スクリプトの実行と検証
  - スクリプトを実行してデータ移行
  - S3 Vectorsインデックスの確認
  - メタデータファイルの検証
  - _要件: 1.2, 1.4_

- [ ] 13. Lambda関数のS3 Vectors API対応
  - VectorDatabaseクラスの書き換え






  - QueryVectors APIの統合

  - メタデータキャッシュの実装
  - _要件: 2.2, 3.2_

- [ ] 13.1 VectorDatabaseクラスのリファクタリング
  - S3 Vectorsクライアントの初期化
  - search()メソッドをQueryVectors API呼び出しに変更
  - メタデータロード機能の実装
  - _要件: 2.2, 3.2_

- [ ] 13.2 エラーハンドリングとリトライロジック
  - S3 Vectors APIエラーのハンドリング
  - リトライロジックの実装（exponential backoff）
  - タイムアウト設定
  - _要件: 2.5, 3.5_

- [ ]* 13.3 S3 Vectors統合のユニットテスト
  - QueryVectors APIのモックテスト
  - メタデータロードのテスト
  - エラーハンドリングのテスト

- [ ] 14. パフォーマンステストと比較
  - 旧システム（JSON）と新システム（S3 Vectors）の比較
  - レイテンシ測定
  - スループット測定
  - _要件: 2.3, 3.3_

- [ ] 14.1 パフォーマンステストスクリプトの作成
  - 複数クエリでのレイテンシ測定
  - 同時実行テスト
  - 結果の可視化
  - _要件: 2.3, 3.3_

- [ ] 14.2 パフォーマンス結果の分析
  - 旧システムとの比較レポート作成
  - ボトルネックの特定
  - 最適化の提案
  - _要件: 2.3, 3.3_

- [ ] 15. 本番環境移行
  - CDKスタックの再デプロイ
  - データ移行の実行
  - 動作確認
  - _要件: すべて_

- [ ] 15.1 ステージング環境でのテスト
  - 更新されたCDKスタックをステージングにデプロイ
  - エンドツーエンドテストの実行
  - パフォーマンス検証
  - _要件: すべて_

- [ ] 15.2 本番環境へのデプロイ
  - 本番環境へのCDKスタックデプロイ
  - データ移行の実行
  - 動作確認とスモークテスト
  - _要件: すべて_

- [ ] 15.3 ドキュメントの更新
  - README.mdにS3 Vectors移行を反映
  - アーキテクチャ図の更新
  - デプロイ手順の更新
  - _要件: すべて_

- [ ] 16. 最終チェックポイント - S3 Vectors移行完了確認
  - すべてのテストが通ることを確認し、問題があれば質問する
